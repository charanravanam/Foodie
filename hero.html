<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Dr Foodie</title>
    
    <!-- Razorpay SDK -->
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#000000',
                        secondary: '#1C1C1E',
                        background: '#F2F2F7',
                        surface: '#FFFFFF',
                        protein: '#FF5252',
                        carbs: '#FFB74D',
                        fats: '#42A5F5',
                        grayText: '#8E8E93',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        heading: ['Poppins', 'sans-serif'],
                    },
                    boxShadow: {
                        'card': '0 2px 8px rgba(0, 0, 0, 0.04)',
                        'floating': '0 8px 16px rgba(0, 0, 0, 0.15)',
                    }
                },
            },
        };
    </script>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">
    
    <!-- Babel for JSX/TSX compilation in browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Import Map -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "lucide-react": "https://esm.sh/lucide-react@0.344.0",
        "recharts": "https://esm.sh/recharts@2.12.0?external=react,react-dom",
        "@google/genai": "https://esm.sh/@google/genai@0.0.12",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js"
      }
    }
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #F2F2F7; -webkit-tap-highlight-color: transparent; }
        ::-webkit-scrollbar { width: 0px; background: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-presets="react,typescript" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Home, BarChart2, Settings, Plus, Flame, ChevronRight, Beef, Wheat, Droplet,
            Apple, ArrowLeft, X, Camera, Trash2, Calendar, User, Scale, Clock, Target,
            Dumbbell, PlayCircle, Timer, Activity, Lock, CheckCircle2, Building2, Home as HomeIcon,
            Moon, Sun, List, LogOut, Crown, Check, Loader2, Mail, UserPen
        } from 'lucide-react';
        import { PieChart, Pie, Cell, ResponsiveContainer } from 'recharts';
        import { GoogleGenAI, Type } from '@google/genai';
        import { initializeApp } from 'firebase/app';
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from 'firebase/auth';

        // ------------------------------------------------------------------
        // CONFIGURATION
        // ------------------------------------------------------------------
        
        // !!! REPLACE THIS WITH YOUR ACTUAL GOOGLE GEMINI API KEY !!!
        window.process = { 
            env: { 
                API_KEY: 'YOUR_GEMINI_API_KEY_HERE' 
            } 
        };

        const firebaseConfig = {
            apiKey: "AIzaSyB4AVx4xPWqBtRs2GXFShiqHQNfYtaXWkU",
            authDomain: "dr-foodie-bc477.firebaseapp.com",
            projectId: "dr-foodie-bc477",
            storageBucket: "dr-foodie-bc477.firebasestorage.app",
            messagingSenderId: "162055987584",
            appId: "1:162055987584:web:f70b64c6b39b0fd14f6165",
            measurementId: "G-2X4R1G8R7H"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        // ------------------------------------------------------------------
        // TYPES & CONSTANTS
        // ------------------------------------------------------------------

        const Gender = { MALE: 'Male', FEMALE: 'Female', OTHER: 'Other' };
        const Goal = { LOSE_WEIGHT: 'Lose Weight', MAINTAIN: 'Maintain', GAIN_WEIGHT: 'Gain Weight' };
        const WorkoutGoal = {
            BELLY_FAT: 'Lower Belly Fat',
            OVERALL_FAT_LOSS: 'Overall Fat Loss',
            LEG_TONING: 'Leg Toning',
            MUSCLE_GAIN: 'Muscle Gain',
            HIIT: 'High Intensity (HIIT)'
        };
        const WorkoutLocation = { HOME: 'Home', GYM: 'Gym' };

        const MAX_FREE_SCANS = 3;

        // ------------------------------------------------------------------
        // DATA (Workouts)
        // ------------------------------------------------------------------

        const HOME_WORKOUTS = {
            [WorkoutGoal.BELLY_FAT]: [
                { id: 'h1', name: 'Mountain Climbers', sets: 3, reps: '45 sec', description: 'Drive knees to chest rapidly.', imageUrl: 'https://images.unsplash.com/photo-1434608519344-49d77a699ded?w=800&q=80', instructions: ["High plank position.", "Drive knees to chest.", "Fast pace."] },
                { id: 'h2', name: 'Plank', sets: 3, reps: '60 sec', description: 'Maintain straight line.', imageUrl: 'https://images.unsplash.com/photo-1517836357463-d25dfeac3438?w=800&q=80', instructions: ["Forearms on floor.", "Straight body line.", "Squeeze core."] },
                { id: 'h3', name: 'Leg Raises', sets: 3, reps: '15 reps', description: 'Lower legs slowly.', imageUrl: 'https://images.unsplash.com/photo-1599058945522-28d584b6f0ff?w=800&q=80', instructions: ["Lie on back.", "Lift legs vertical.", "Lower slowly."] },
                { id: 'h4', name: 'Russian Twists', sets: 3, reps: '20 reps', description: 'Rotate torso.', imageUrl: 'https://images.unsplash.com/photo-1541534741688-6078c6bfb5c5?w=800&q=80', instructions: ["Sit, feet up.", "Twist side to side.", "Touch floor."] }
            ],
            [WorkoutGoal.OVERALL_FAT_LOSS]: [
                { id: 'h5', name: 'Burpees', sets: 3, reps: '12 reps', description: 'Full body explosive.', imageUrl: 'https://images.unsplash.com/photo-1599058945522-28d584b6f0ff?w=800&q=80', instructions: ["Squat, kick back.", "Pushup.", "Jump up."] },
                { id: 'h6', name: 'Jump Squats', sets: 4, reps: '15 reps', description: 'Explode upwards.', imageUrl: 'https://images.unsplash.com/photo-1574680096145-d05b474e2155?w=800&q=80', instructions: ["Squat down.", "Jump up explosively.", "Land soft."] },
                { id: 'h7', name: 'Pushups', sets: 3, reps: '12 reps', description: 'Chest to floor.', imageUrl: 'https://images.unsplash.com/photo-1571019614242-c5c5dee9f50b?w=800&q=80', instructions: ["High plank.", "Lower chest.", "Push up."] }
            ],
            'default': [
                { id: 'd1', name: 'Jumping Jacks', sets: 3, reps: '50 reps', description: 'Cardio warmup.', imageUrl: 'https://images.unsplash.com/photo-1544367563-12123d8965cd?w=800&q=80', instructions: ["Feet apart, arms up.", "Feet together, arms down."] },
                { id: 'd2', name: 'Squats', sets: 3, reps: '20 reps', description: 'Sit back.', imageUrl: 'https://images.unsplash.com/photo-1574680096145-d05b474e2155?w=800&q=80', instructions: ["Hips back.", "Chest up.", "Stand."] }
            ]
        };

        const GYM_WEEKLY_PLAN = {
            1: { title: "Chest & Triceps", focus: "Push Day", exercises: [{ id: 'g1', name: 'Bench Press', sets: 4, reps: '10', description: 'Barbell press.', imageUrl: 'https://images.unsplash.com/photo-1517836357463-d25dfeac3438?w=800&q=80', instructions: ["Lower bar to chest.", "Press up."] }] },
            2: { title: "Back & Biceps", focus: "Pull Day", exercises: [{ id: 'g6', name: 'Lat Pulldown', sets: 4, reps: '12', description: 'Wide grip pull.', imageUrl: 'https://images.unsplash.com/photo-1605296867304-46d5465a13f1?w=800&q=80', instructions: ["Pull to chest.", "Squeeze back."] }] },
            3: { title: "Legs", focus: "Leg Day", exercises: [{ id: 'g11', name: 'Leg Press', sets: 4, reps: '15', description: 'Push with heels.', imageUrl: 'https://images.unsplash.com/photo-1574680096145-d05b474e2155?w=800&q=80', instructions: ["Lower weight.", "Push back up."] }] },
            4: { title: "Shoulders", focus: "Delts", exercises: [{ id: 'g16', name: 'Overhead Press', sets: 4, reps: '10', description: 'Press overhead.', imageUrl: 'https://images.unsplash.com/photo-1541534741688-6078c6bfb5c5?w=800&q=80', instructions: ["Press weights up.", "Control down."] }] },
            5: { title: "Arms", focus: "Pump", exercises: [{ id: 'g20', name: 'Bicep Curls', sets: 4, reps: '12', description: 'Curl weights.', imageUrl: 'https://images.unsplash.com/photo-1581009146145-b5ef050c2e1e?w=800&q=80', instructions: ["Curl up.", "Lower slowly."] }] },
            6: { title: "Full Body", focus: "Conditioning", exercises: [{ id: 'g24', name: 'Kettlebell Swings', sets: 4, reps: '20', description: 'Hinge hips.', imageUrl: 'https://images.unsplash.com/photo-1599058945522-28d584b6f0ff?w=800&q=80', instructions: ["Swing to eye level.", "Snap hips."] }] },
            0: { title: "Rest Day", focus: "Recovery", exercises: [{ id: 'g0', name: 'Walking', sets: 1, reps: '30 min', description: 'Active recovery.', imageUrl: 'https://images.unsplash.com/photo-1476480862126-209bfaa8edc8?w=800&q=80', instructions: ["Walk.", "Relax."] }] }
        };

        // ------------------------------------------------------------------
        // SERVICES
        // ------------------------------------------------------------------

        const analyzeFoodImage = async (base64Image, userProfile) => {
            const apiKey = window.process.env.API_KEY;
            
            // Mock response if API key is not set
            if (!apiKey || apiKey.includes('YOUR_GEMINI_API_KEY')) {
                console.warn("API Key missing. Returning mock data.");
                return new Promise(resolve => setTimeout(() => resolve({
                    foodName: "Grilled Chicken Salad (Mock)",
                    calories: 420,
                    protein: 35,
                    carbs: 12,
                    fat: 18,
                    healthScore: 9,
                    microAnalysis: `(Demo Mode) This is a great meal for your goal of ${userProfile.goal}. High protein helps muscle retention while low carbs fit your fat loss plan.`
                }), 2000));
            }

            const ai = new GoogleGenAI({ apiKey });
            const systemPrompt = `
                You are Dr Foodie, a nutritionist AI. Analyze this food image.
                User: ${userProfile.gender}, ${userProfile.weight}kg, Goal: ${userProfile.goal}.
                Target: ${userProfile.targetWeight}kg in ${userProfile.durationWeeks} weeks.
                Return JSON with: foodName, calories (number), protein (number), carbs (number), fat (number), healthScore (1-10 number), microAnalysis (string advice).
                If not food, return "Not Food" for foodName and 0 for values.
            `;

            try {
                const response = await ai.models.generateContent({
                    model: "gemini-2.5-flash",
                    contents: {
                        parts: [
                            { inlineData: { mimeType: "image/jpeg", data: base64Image } },
                            { text: "Analyze this meal." }
                        ]
                    },
                    config: {
                        systemInstruction: systemPrompt,
                        responseMimeType: "application/json"
                    }
                });
                
                const text = response.text;
                return JSON.parse(text);
            } catch (error) {
                console.error("Gemini Error:", error);
                throw error;
            }
        };

        // ------------------------------------------------------------------
        // COMPONENTS
        // ------------------------------------------------------------------

        const AuthComponent = () => {
            const [isLogin, setIsLogin] = useState(true);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState(null);
            const [loading, setLoading] = useState(false);

            const handleSubmit = async (e) => {
                e.preventDefault();
                setError(null);
                setLoading(true);
                try {
                    if (isLogin) await signInWithEmailAndPassword(auth, email, password);
                    else await createUserWithEmailAndPassword(auth, email, password);
                } catch (err) {
                    setError(err.message.replace('Firebase: ', '').replace('auth/', ''));
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen flex flex-col items-center justify-center p-6 bg-white">
                    <div className="w-full max-w-sm">
                        <div className="text-center mb-8">
                             <img src="https://www.foodieqr.com/assets/img/logo.svg" alt="Dr Foodie" className="h-16 mx-auto mb-4" />
                            <h1 className="text-3xl font-heading font-bold mb-2">Dr Foodie</h1>
                            <p className="text-gray-500">{isLogin ? 'Welcome Back' : 'Create Account'}</p>
                        </div>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div className="relative">
                                <Mail className="absolute left-4 top-4 text-gray-400" size={20} />
                                <input type="email" placeholder="Email" value={email} onChange={e=>setEmail(e.target.value)} className="w-full pl-12 p-4 bg-gray-50 rounded-2xl border border-transparent focus:border-black focus:outline-none" required />
                            </div>
                            <div className="relative">
                                <Lock className="absolute left-4 top-4 text-gray-400" size={20} />
                                <input type="password" placeholder="Password" value={password} onChange={e=>setPassword(e.target.value)} className="w-full pl-12 p-4 bg-gray-50 rounded-2xl border border-transparent focus:border-black focus:outline-none" required />
                            </div>
                            {error && <p className="text-red-500 text-sm text-center bg-red-50 p-2 rounded-lg">{error}</p>}
                            <button type="submit" disabled={loading} className="w-full bg-black text-white p-4 rounded-2xl font-bold flex justify-center items-center gap-2 hover:scale-[1.02] transition-transform">
                                {loading ? <Loader2 className="animate-spin" /> : (isLogin ? 'Sign In' : 'Sign Up')}
                            </button>
                        </form>
                        <button onClick={() => setIsLogin(!isLogin)} className="mt-6 w-full text-center text-sm font-bold text-gray-600 hover:text-black">
                            {isLogin ? 'New here? Create Account' : 'Already have an account? Log In'}
                        </button>
                    </div>
                </div>
            );
        };

        const Onboarding = ({ onComplete, initialData }) => {
            const [step, setStep] = useState(1);
            const [data, setData] = useState(initialData || {
                name: '', age: 25, gender: Gender.MALE, height: 175, weight: 70, targetWeight: 65, goal: Goal.LOSE_WEIGHT, durationWeeks: 12
            });

            const update = (key, val) => setData({...data, [key]: val});

            return (
                <div className="min-h-screen bg-white p-6 flex flex-col justify-center items-center">
                    <div className="w-full max-w-md">
                        <div className="mb-8">
                            <img src="https://www.foodieqr.com/assets/img/logo.svg" alt="Dr Foodie" className="h-12 mx-auto mb-6" />
                            <div className="h-2 bg-gray-100 rounded-full overflow-hidden">
                                <div className="h-full bg-black transition-all duration-300" style={{width: `${(step/3)*100}%`}}></div>
                            </div>
                        </div>
                        
                        <div className="bg-white p-6 rounded-[32px] shadow-card min-h-[450px] flex flex-col border border-gray-100">
                            {step === 1 && (
                                <div className="space-y-4 animate-fade-in flex-1">
                                    <h2 className="text-2xl font-bold flex items-center gap-2"><User className="text-black"/> About You</h2>
                                    <div className="space-y-4 pt-2">
                                        <input placeholder="Name" value={data.name} onChange={e=>update('name', e.target.value)} className="w-full p-4 bg-gray-50 rounded-xl font-medium" />
                                        <div className="flex gap-4">
                                            <input type="number" placeholder="Age" value={data.age} onChange={e=>update('age', Number(e.target.value))} className="w-full p-4 bg-gray-50 rounded-xl font-medium" />
                                            <select value={data.gender} onChange={e=>update('gender', e.target.value)} className="w-full p-4 bg-gray-50 rounded-xl font-medium">
                                                {Object.values(Gender).map(g=><option key={g} value={g}>{g}</option>)}
                                            </select>
                                        </div>
                                        <div className="relative">
                                            <input type="number" placeholder="Height" value={data.height} onChange={e=>update('height', Number(e.target.value))} className="w-full p-4 bg-gray-50 rounded-xl font-medium" />
                                            <span className="absolute right-4 top-4 text-gray-400 font-medium">cm</span>
                                        </div>
                                    </div>
                                </div>
                            )}
                            {step === 2 && (
                                <div className="space-y-4 animate-fade-in flex-1">
                                    <h2 className="text-2xl font-bold flex items-center gap-2"><Target className="text-black"/> Your Goal</h2>
                                    <div className="space-y-3 pt-2">
                                        {Object.values(Goal).map(g => (
                                            <button key={g} onClick={()=>update('goal', g)} className={`w-full p-5 rounded-xl text-left font-bold border transition-all flex justify-between items-center ${data.goal === g ? 'bg-black text-white border-black shadow-lg' : 'border-gray-100 text-gray-600 hover:bg-gray-50'}`}>
                                                {g}
                                                {data.goal === g && <Check size={20}/>}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            )}
                            {step === 3 && (
                                <div className="space-y-6 animate-fade-in flex-1">
                                    <h2 className="text-2xl font-bold flex items-center gap-2"><Scale className="text-black"/> Targets</h2>
                                    
                                    <div className="bg-gray-50 p-4 rounded-xl flex justify-between items-center">
                                        <label className="font-bold text-gray-500">Current Weight</label>
                                        <div className="flex items-center gap-2">
                                            <input type="number" value={data.weight} onChange={e=>update('weight', Number(e.target.value))} className="w-20 bg-transparent text-right font-bold text-2xl outline-none" />
                                            <span className="text-sm font-bold text-gray-400">kg</span>
                                        </div>
                                    </div>
                                    
                                    <div className="bg-black text-white p-4 rounded-xl flex justify-between items-center shadow-lg">
                                        <label className="font-bold text-gray-300">Target Weight</label>
                                        <div className="flex items-center gap-2">
                                            <input type="number" value={data.targetWeight} onChange={e=>update('targetWeight', Number(e.target.value))} className="w-20 bg-transparent text-right font-bold text-2xl outline-none text-white" />
                                            <span className="text-sm font-bold text-gray-500">kg</span>
                                        </div>
                                    </div>

                                    <div>
                                        <div className="flex justify-between mb-2">
                                            <label className="font-bold text-sm">Duration</label>
                                            <span className="text-sm font-bold bg-gray-100 px-2 rounded">{data.durationWeeks} Weeks</span>
                                        </div>
                                        <input type="range" min="4" max="52" value={data.durationWeeks} onChange={e=>update('durationWeeks', Number(e.target.value))} className="w-full accent-black h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" />
                                    </div>
                                </div>
                            )}

                            <button onClick={() => step < 3 ? setStep(step+1) : onComplete({...data, isOnboarded: true})} className="w-full bg-black text-white p-4 rounded-2xl font-bold mt-6 shadow-xl hover:scale-[1.02] transition-transform flex justify-center items-center gap-2">
                                {step === 3 ? (initialData ? 'Save Changes' : 'Start Journey') : 'Next'} <ChevronRight size={20}/>
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const PremiumModal = ({ isOpen, onClose, onUpgrade }) => {
            if (!isOpen) return null;
            
            const handlePayment = () => {
                const options = {
                    key: "rzp_live_Rp3PKVq2k7vnBq",
                    amount: 4900, // 49 INR
                    currency: "INR",
                    name: "Dr Foodie",
                    description: "Pro Subscription",
                    image: "https://www.foodieqr.com/assets/img/logo.svg",
                    handler: function(res) { onUpgrade(); },
                    theme: { color: "#000000" }
                };
                const rzp = new window.Razorpay(options);
                rzp.open();
            };

            return (
                <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in">
                    <div className="bg-white w-full max-w-sm rounded-[32px] overflow-hidden relative shadow-2xl">
                        <button onClick={onClose} className="absolute top-4 right-4 bg-gray-100 p-2 rounded-full hover:bg-gray-200 transition-colors z-10"><X size={20}/></button>
                        
                        <div className="bg-gradient-to-br from-black to-gray-800 p-8 text-center text-white">
                            <Crown size={48} className="mx-auto mb-2 text-yellow-400 fill-yellow-400" />
                            <h2 className="text-2xl font-bold">Dr Foodie Pro</h2>
                            <p className="opacity-80 text-sm">Unlock Unlimited Potential</p>
                        </div>

                        <div className="p-6">
                            <ul className="space-y-4 mb-6">
                                {['Unlimited Food Scans', 'Personalized Workout Plans', 'Deep Macro Analysis', 'Ad-free Experience'].map(i=>(
                                    <li key={i} className="flex gap-3 items-center font-medium text-gray-700">
                                        <div className="bg-green-100 p-1 rounded-full"><Check size={14} className="text-green-600"/></div>
                                        {i}
                                    </li>
                                ))}
                            </ul>
                            
                            <div className="text-center mb-6">
                                <span className="text-3xl font-bold">₹49</span><span className="text-gray-500"> / month</span>
                            </div>

                            <button onClick={handlePayment} className="w-full bg-black text-white p-4 rounded-xl font-bold flex justify-center items-center gap-2 hover:scale-[1.02] transition-transform shadow-lg">
                                Upgrade Now
                            </button>
                            <p className="text-center text-xs text-gray-400 mt-3">Secured by Razorpay. Cancel anytime.</p>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [profile, setProfile] = useState(null);
            const [view, setView] = useState('home');
            const [scans, setScans] = useState([]);
            const [showPremium, setShowPremium] = useState(false);
            const [isAnalyzing, setIsAnalyzing] = useState(false);
            const [analysis, setAnalysis] = useState(null);
            const [selectedExercise, setSelectedExercise] = useState(null);
            const [loadingAuth, setLoadingAuth] = useState(true);
            const fileInputRef = useRef(null);

            // Auth State Listener
            useEffect(() => {
                const unsub = onAuthStateChanged(auth, (u) => {
                    setUser(u);
                    setLoadingAuth(false);
                    if (u) {
                        const saved = localStorage.getItem(`drfoodie_${u.uid}`);
                        if (saved) setProfile(JSON.parse(saved));
                    }
                });
                return () => unsub();
            }, []);

            const saveProfile = (p) => {
                const newProfile = { ...profile, ...p };
                setProfile(newProfile);
                if (user) localStorage.setItem(`drfoodie_${user.uid}`, JSON.stringify(newProfile));
            };

            const handleScan = async (e) => {
                const file = e.target.files?.[0];
                if (!file) return;
                
                // Logic: Allow 3 free scans, then require premium
                if (!profile.isPremium && scans.length >= MAX_FREE_SCANS) {
                    setShowPremium(true);
                    if(fileInputRef.current) fileInputRef.current.value = '';
                    return;
                }

                setIsAnalyzing(true);
                setView('analysis');
                
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = async () => {
                    const base64 = reader.result.split(',')[1];
                    try {
                        const res = await analyzeFoodImage(base64, profile);
                        const newScan = { ...res, imageUrl: reader.result, id: Date.now(), timestamp: new Date().toISOString() };
                        setScans([newScan, ...scans]);
                        setAnalysis(newScan);
                    } catch (err) {
                        alert("Analysis failed. Please try again.");
                        setView('home');
                    } finally {
                        setIsAnalyzing(false);
                    }
                };
            };

            if (loadingAuth) return <div className="h-screen flex items-center justify-center"><Loader2 className="animate-spin text-black" size={32}/></div>;
            if (!user) return <AuthComponent />;
            if (!profile) return <Onboarding onComplete={saveProfile} />;

            // Helper to calculate calorie goal (simplified BMR)
            const getCalorieTarget = () => {
                const base = (10 * profile.weight) + (6.25 * profile.height) - (5 * profile.age) + (profile.gender === Gender.MALE ? 5 : -161);
                const multiplier = 1.375;
                let target = base * multiplier;
                if(profile.goal === Goal.LOSE_WEIGHT) target -= 500;
                if(profile.goal === Goal.GAIN_WEIGHT) target += 500;
                return Math.round(target);
            }

            const renderHome = () => {
                const totalCals = scans.reduce((a, b) => a + (b.calories || 0), 0);
                const targetCals = getCalorieTarget();
                const remaining = Math.max(0, targetCals - totalCals);
                
                return (
                    <div className="pb-24 pt-4 animate-fade-in">
                        <header className="flex justify-between items-center mb-6">
                            <div className="flex items-center gap-2">
                                <img src="https://www.foodieqr.com/assets/img/logo.svg" alt="Logo" className="h-8" />
                            </div>
                            <button onClick={()=>setShowPremium(true)} className="px-3 py-1 bg-white border rounded-full text-xs font-bold flex items-center gap-1 shadow-sm">
                                {profile.isPremium ? <Crown size={14} className="text-yellow-500 fill-yellow-500"/> : 
                                    <><span className={scans.length >= MAX_FREE_SCANS ? 'text-red-500' : 'text-black'}>{Math.max(0, MAX_FREE_SCANS - scans.length)}</span> / {MAX_FREE_SCANS} Free</>
                                }
                            </button>
                        </header>
                        
                        <div className="bg-white p-6 rounded-[32px] shadow-card mb-6 flex items-center justify-between relative overflow-hidden">
                            <div>
                                <div className="flex items-baseline gap-1">
                                    <span className="text-5xl font-heading font-bold">{totalCals}</span>
                                    <span className="text-lg text-grayText font-medium">/{targetCals}</span>
                                </div>
                                <div className="text-sm text-grayText font-medium mt-1">Calories Eaten</div>
                            </div>
                            <div className="w-24 h-24 relative">
                                <ResponsiveContainer>
                                    <PieChart>
                                        <Pie data={[{value: totalCals, color: '#000'}, {value: remaining, color: '#f3f4f6'}]} dataKey="value" innerRadius={35} outerRadius={45} startAngle={90} endAngle={-270}>
                                            <Cell fill="#000"/><Cell fill="#f3f4f6"/>
                                        </Pie>
                                    </PieChart>
                                </ResponsiveContainer>
                                <Flame className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-black fill-black" size={20}/>
                            </div>
                        </div>

                        <div className="grid grid-cols-3 gap-3 mb-8">
                           {[{l:'Protein', v: scans.reduce((a,b)=>a+b.protein,0), t:150, c:'text-protein', bg:'bg-red-50'},
                             {l:'Carbs', v: scans.reduce((a,b)=>a+b.carbs,0), t:200, c:'text-carbs', bg:'bg-orange-50'},
                             {l:'Fats', v: scans.reduce((a,b)=>a+b.fat,0), t:60, c:'text-fats', bg:'bg-blue-50'}].map((m,i)=>(
                               <div key={i} className={`rounded-[24px] p-4 ${m.bg} flex flex-col items-center justify-between h-32`}>
                                   <span className={`font-bold text-xs uppercase ${m.c}`}>{m.l}</span>
                                   <span className="text-2xl font-bold">{m.v}g</span>
                                   <div className="w-full bg-white/50 h-1.5 rounded-full overflow-hidden"><div className={`h-full ${m.c.replace('text','bg')}`} style={{width: `${Math.min(100, (m.v/m.t)*100)}%`}}></div></div>
                               </div>
                           ))}
                        </div>

                        <h3 className="font-bold mb-4 text-lg font-heading">Recent Meals</h3>
                        <div className="space-y-3">
                            {scans.length === 0 ? 
                                <div onClick={()=>fileInputRef.current.click()} className="text-center text-gray-400 py-12 border-2 border-dashed rounded-[24px] cursor-pointer hover:bg-gray-50 transition-colors">
                                    <Camera className="mx-auto mb-2 opacity-50"/>
                                    Tap to scan your first meal
                                </div> : 
                                scans.map(s => (
                                    <div key={s.id} onClick={()=>{setAnalysis(s); setView('analysis')}} className="bg-white p-3 rounded-[24px] flex gap-4 shadow-card items-center hover:bg-gray-50 transition-colors cursor-pointer">
                                        <img src={s.imageUrl} className="w-16 h-16 rounded-2xl object-cover bg-gray-100" />
                                        <div>
                                            <div className="font-bold text-sm mb-1">{s.foodName}</div>
                                            <div className="text-xs text-gray-500 font-medium">{s.calories} kcal • {s.protein}g Protein</div>
                                        </div>
                                        <ChevronRight className="ml-auto text-gray-300"/>
                                    </div>
                                ))
                            }
                        </div>
                    </div>
                );
            };

            const renderAnalysis = () => {
                if (isAnalyzing) return (
                    <div className="h-screen flex flex-col items-center justify-center bg-white">
                        <div className="w-16 h-16 border-4 border-black border-t-transparent rounded-full animate-spin mb-6"></div>
                        <h2 className="text-2xl font-bold font-heading">Analyzing Meal</h2>
                        <p className="text-gray-500 mt-2">Identifying ingredients...</p>
                    </div>
                );
                
                if (!analysis) return null;
                return (
                    <div className="pb-24 pt-4 animate-fade-in">
                        <div className="flex items-center gap-4 mb-4">
                            <button onClick={()=>setView('home')} className="p-2 bg-white rounded-full shadow-sm hover:bg-gray-100"><ArrowLeft size={20}/></button>
                            <h2 className="font-bold text-lg">Analysis Result</h2>
                        </div>
                        <div className="bg-white rounded-[32px] overflow-hidden shadow-card mb-4">
                            <div className="relative h-64">
                                <img src={analysis.imageUrl} className="w-full h-full object-cover" />
                                <div className="absolute bottom-4 right-4 bg-white/90 backdrop-blur-md px-3 py-1 rounded-full text-xs font-bold text-green-700 shadow-sm border border-green-100">
                                    Health Score: {analysis.healthScore}/10
                                </div>
                            </div>
                            <div className="p-6">
                                <h1 className="text-3xl font-heading font-bold mb-2">{analysis.foodName}</h1>
                                <div className="flex justify-between items-end border-b border-gray-100 pb-6 mb-6">
                                    <div>
                                        <span className="text-xs text-gray-500 font-bold uppercase">Calories</span>
                                        <div className="text-4xl font-heading font-bold">{analysis.calories}</div>
                                    </div>
                                    <div className="flex gap-2">
                                        {[{l:'PRO',v:analysis.protein, c:'bg-red-50 text-red-500'}, {l:'CARB',v:analysis.carbs, c:'bg-orange-50 text-orange-500'}, {l:'FAT',v:analysis.fat, c:'bg-blue-50 text-blue-500'}].map(m => (
                                            <div key={m.l} className={`${m.c} p-2 rounded-xl text-center min-w-[60px]`}>
                                                <div className="text-[10px] font-bold opacity-70">{m.l}</div>
                                                <div className="font-bold text-lg">{m.v}g</div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                                <div className="bg-gray-50 p-5 rounded-[24px] text-sm leading-relaxed border border-gray-100">
                                    <h3 className="font-bold mb-2 flex items-center gap-2 text-base"><Apple size={18}/> Dr Foodie's Note</h3>
                                    {analysis.microAnalysis}
                                </div>
                            </div>
                        </div>
                        <button onClick={()=>fileInputRef.current.click()} className="w-full bg-black text-white p-4 rounded-2xl font-bold shadow-lg hover:scale-[1.01] transition-transform">Scan Another Meal</button>
                    </div>
                );
            };

            const renderWorkouts = () => {
                if (!profile.isPremium) return (
                    <div className="h-full flex flex-col items-center justify-center text-center pt-20 px-6">
                        <div className="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mb-6">
                            <Lock size={32} className="text-gray-400"/>
                        </div>
                        <h2 className="text-2xl font-heading font-bold mb-2">Pro Workouts</h2>
                        <p className="text-gray-500 mb-8 max-w-xs">Get personalized workout plans tailored to your {profile.goal} goal.</p>
                        <button onClick={()=>setShowPremium(true)} className="w-full bg-black text-white px-6 py-4 rounded-2xl font-bold shadow-lg flex items-center justify-center gap-2">
                            <Crown size={20} className="text-yellow-400 fill-yellow-400"/> Unlock for ₹49
                        </button>
                    </div>
                );
                
                // Show location selector if not set
                if (!profile.workoutLocation) {
                    return (
                        <div className="pt-6 animate-fade-in">
                            <h1 className="text-2xl font-bold font-heading mb-6">Setup Plan</h1>
                            <div className="space-y-4">
                                <button onClick={()=>saveProfile({workoutLocation: WorkoutLocation.GYM})} className="w-full bg-white p-6 rounded-[24px] shadow-card flex items-center justify-between font-bold text-lg hover:bg-gray-50">
                                    <span className="flex items-center gap-3"><Building2/> Gym Workout</span> <ChevronRight/>
                                </button>
                                <button onClick={()=>saveProfile({workoutLocation: WorkoutLocation.HOME})} className="w-full bg-white p-6 rounded-[24px] shadow-card flex items-center justify-between font-bold text-lg hover:bg-gray-50">
                                    <span className="flex items-center gap-3"><HomeIcon/> Home Workout</span> <ChevronRight/>
                                </button>
                            </div>
                        </div>
                    );
                }

                if (profile.workoutLocation === WorkoutLocation.HOME && !profile.workoutGoal) {
                    return (
                        <div className="pt-6 animate-fade-in">
                            <div className="flex items-center gap-4 mb-6">
                                <button onClick={()=>saveProfile({workoutLocation: null})} className="p-2 bg-white rounded-full"><ArrowLeft/></button>
                                <h1 className="text-2xl font-bold font-heading">Home Goal</h1>
                            </div>
                            <div className="space-y-3">
                                {Object.values(WorkoutGoal).map(g => (
                                    <button key={g} onClick={()=>saveProfile({workoutGoal: g})} className="w-full bg-white p-5 rounded-[20px] shadow-card text-left font-bold hover:bg-gray-50 flex justify-between">
                                        {g} <ChevronRight className="text-gray-300"/>
                                    </button>
                                ))}
                            </div>
                        </div>
                    );
                }
                
                const isGym = profile.workoutLocation === WorkoutLocation.GYM;
                const exercises = isGym ? GYM_WEEKLY_PLAN[new Date().getDay()].exercises : (HOME_WORKOUTS[profile.workoutGoal] || HOME_WORKOUTS.default);
                const title = isGym ? GYM_WEEKLY_PLAN[new Date().getDay()].title : 'Home Circuit';

                if (selectedExercise) return (
                    <div className="fixed inset-0 bg-white z-50 p-6 overflow-y-auto animate-fade-in">
                        <button onClick={()=>setSelectedExercise(null)} className="mb-6 p-2 bg-gray-100 rounded-full hover:bg-gray-200"><ArrowLeft size={24}/></button>
                        <div className="rounded-[32px] overflow-hidden shadow-card mb-8 h-64 relative bg-gray-100">
                             <img src={selectedExercise.imageUrl} className="w-full h-full object-cover"/>
                             <div className="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent"></div>
                             <div className="absolute bottom-6 left-6 text-white">
                                 <h1 className="text-3xl font-heading font-bold mb-2">{selectedExercise.name}</h1>
                                 <div className="flex gap-2">
                                     <span className="bg-white/20 backdrop-blur-md px-3 py-1 rounded-full text-sm font-bold">{selectedExercise.sets} Sets</span>
                                     <span className="bg-white/20 backdrop-blur-md px-3 py-1 rounded-full text-sm font-bold">{selectedExercise.reps}</span>
                                 </div>
                             </div>
                        </div>
                        <h3 className="text-xl font-bold mb-4 flex items-center gap-2"><List size={20}/> Instructions</h3>
                        <div className="space-y-6">
                            {selectedExercise.instructions.map((step, i)=>(
                                <div key={i} className="flex gap-4">
                                    <div className="w-8 h-8 rounded-full bg-black text-white flex-shrink-0 flex items-center justify-center font-bold text-sm">{i+1}</div>
                                    <p className="text-gray-700 font-medium leading-relaxed pt-1">{step}</p>
                                </div>
                            ))}
                        </div>
                    </div>
                );

                return (
                    <div className="pb-24 pt-6 animate-fade-in">
                        <div className="flex justify-between items-start mb-6">
                            <div>
                                <h1 className="text-2xl font-bold font-heading">{title}</h1>
                                <p className="text-gray-500 text-sm mt-1">{isGym ? GYM_WEEKLY_PLAN[new Date().getDay()].focus : profile.workoutGoal}</p>
                            </div>
                            <button onClick={()=>saveProfile({workoutLocation: null, workoutGoal: null})} className="p-2 bg-white rounded-full shadow-sm"><Settings size={20}/></button>
                        </div>

                        <div className="space-y-4">
                            {exercises.map((ex, i) => (
                                <div key={i} onClick={()=>setSelectedExercise(ex)} className="bg-white p-4 rounded-[24px] flex items-center gap-4 shadow-card hover:bg-gray-50 cursor-pointer">
                                    <div className="w-12 h-12 bg-gray-100 rounded-2xl flex items-center justify-center font-bold text-gray-400">{i+1}</div>
                                    <div>
                                        <div className="font-bold">{ex.name}</div>
                                        <div className="text-xs text-gray-500 font-medium">{ex.sets} sets • {ex.reps}</div>
                                    </div>
                                    <ChevronRight className="ml-auto text-gray-300"/>
                                </div>
                            ))}
                        </div>
                    </div>
                );
            };

            return (
                <div className="max-w-md mx-auto min-h-screen bg-background text-black relative shadow-2xl overflow-hidden">
                    <input type="file" ref={fileInputRef} className="hidden" accept="image/*" onChange={handleScan} />
                    
                    <div className="px-6 h-full overflow-y-auto max-h-screen no-scrollbar">
                        {view === 'home' && renderHome()}
                        {view === 'analysis' && renderAnalysis()}
                        {view === 'workouts' && renderWorkouts()}
                        {view === 'settings' && (
                            <div className="pt-6 pb-24 animate-fade-in">
                                <h1 className="text-2xl font-bold font-heading mb-6">Settings</h1>
                                <div className="bg-white rounded-[32px] overflow-hidden shadow-card p-4">
                                    <div className="flex items-center gap-4 p-4 mb-4 bg-gray-50 rounded-[20px]">
                                        <div className="w-12 h-12 bg-black text-white rounded-full flex items-center justify-center font-bold text-lg">{profile.name.charAt(0)}</div>
                                        <div>
                                            <div className="font-bold">{profile.name}</div>
                                            <div className="text-xs text-gray-500">{profile.isPremium ? 'Premium Plan' : 'Free Plan'}</div>
                                        </div>
                                    </div>
                                    <button onClick={()=>setProfile(null)} className="w-full p-4 text-left font-medium flex justify-between hover:bg-gray-50 rounded-xl"><span className="flex gap-3"><UserPen size={20}/> Edit Profile</span> <ChevronRight size={18} className="text-gray-300"/></button>
                                    <button onClick={()=>setShowPremium(true)} className="w-full p-4 text-left font-medium flex justify-between hover:bg-gray-50 rounded-xl"><span className="flex gap-3"><Crown size={20}/> Subscription</span> <ChevronRight size={18} className="text-gray-300"/></button>
                                    <button onClick={()=>signOut(auth)} className="w-full p-4 text-left font-medium text-red-500 hover:bg-red-50 rounded-xl flex gap-3"><LogOut size={20}/> Sign Out</button>
                                </div>
                            </div>
                        )}
                    </div>

                    {view !== 'analysis' && (
                        <div className="fixed bottom-0 left-0 right-0 bg-white border-t p-2 pb-6 flex justify-between items-end max-w-md mx-auto z-40 px-6">
                            <button onClick={()=>setView('home')} className={`flex flex-col items-center w-16 gap-1 ${view==='home'?'text-black':'text-gray-400'}`}><Home size={24} strokeWidth={view==='home'?2.5:2}/><span className="text-[10px] font-medium">Home</span></button>
                            <button onClick={()=>setView('workouts')} className={`flex flex-col items-center w-16 gap-1 ${view==='workouts'?'text-black':'text-gray-400'}`}><Dumbbell size={24} strokeWidth={view==='workouts'?2.5:2}/><span className="text-[10px] font-medium">Plan</span></button>
                            
                            <div className="absolute left-1/2 -translate-x-1/2 -top-6">
                                <button onClick={()=>fileInputRef.current.click()} className="w-14 h-14 bg-black rounded-full flex items-center justify-center text-white border-4 border-white shadow-xl hover:scale-105 transition-transform"><Plus size={28}/></button>
                            </div>

                            <button onClick={()=>setView('stats')} className={`flex flex-col items-center w-16 gap-1 ${view==='stats'?'text-black':'text-gray-400'}`}><BarChart2 size={24} strokeWidth={view==='stats'?2.5:2}/><span className="text-[10px] font-medium">Stats</span></button>
                            <button onClick={()=>setView('settings')} className={`flex flex-col items-center w-16 gap-1 ${view==='settings'?'text-black':'text-gray-400'}`}><Settings size={24} strokeWidth={view==='settings'?2.5:2}/><span className="text-[10px] font-medium">Settings</span></button>
                        </div>
                    )}

                    <PremiumModal isOpen={showPremium} onClose={()=>setShowPremium(false)} onUpgrade={()=>{saveProfile({isPremium: true}); setShowPremium(false);}} />
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>